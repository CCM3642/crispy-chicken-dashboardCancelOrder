<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ุชูุฑูุฑ ุงูุทูุจุงุช ุงูููุบุงุฉ โ ูุณุฎุชู ุงูุดุฎุตูุฉ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/tabletop@1.6.1/tabletop.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .response-cell { min-width: 120px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-yellow-400 p-4 border-b border-red-600 text-center">
    <h1 class="text-2xl font-bold">ุชูุฑูุฑ ุงูุทูุจุงุช ุงูููุบูุฉ ูุงููุชูุงุฒุน ุนูููุง</h1>
    <p class="text-sm">ุชูุฑูุฑู ุงูุดุฎุตู ุงููููู</p>
  </header>
  
  <main class="max-w-6xl mx-auto p-4">
    <!-- ูุนูููุงุช ุงูุชูุฑูุฑ -->
    <div class="bg-white rounded-lg shadow p-4 mb-4">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-lg font-semibold">ูุนูููุงุช ุงูุชูุฑูุฑ</h2>
          <p class="text-sm text-gray-600">ุงููุนุฏ: <span class="font-medium">ุฃูุช</span> | ุงูุชุงุฑูุฎ: <span id="reportDate" class="font-medium"></span></p>
        </div>
        <div class="flex gap-2">
          <button onclick="saveToLocal()" class="bg-blue-600 text-white px-3 py-1 rounded">ุญูุธ ูุญูู</button>
          <button onclick="sendReport()" class="bg-green-600 text-white px-3 py-1 rounded">ุฅุฑุณุงู ุงูุชูุฑูุฑ</button>
        </div>
      </div>
    </div>
    
    <!-- ุงูุฌุฏูู -->
    <div class="overflow-x-auto bg-white rounded-lg shadow">
      <table id="reportTable" class="w-full border text-center text-sm">
        <thead class="bg-yellow-100">
          <tr>
            <th class="border px-2 py-1">ุงูุชุงุฑูุฎ</th>
            <th class="border px-2 py-1">ุงููููุน</th>
            <th class="border px-2 py-1">ุงููุฌูุน</th>
            <th class="border px-2 py-1">ุฑูู ุงูุทูุจ</th>
            <th class="border px-2 py-1">ูููุฉ ุงููุงุชูุฑุฉ</th>
            <th class="border px-2 py-1">ุงูุญุงูุฉ ุงูููุงุฆูุฉ</th>
            <th class="border px-2 py-1">ุฑุฏ ุงููุฏูุฑ</th>
            <th class="border px-2 py-1">ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody id="reportBody">
          <!-- ุณูุชู ุชุญููู ุงูุตููู ูู Google Sheets -->
        </tbody>
      </table>
    </div>
    
    <!-- ุฅุญุตุงุฆูุงุช ุงูุชูุฑูุฑ -->
    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h3 class="font-semibold">ุฅุฌูุงูู ุงูุทูุจุงุช</h3>
        <p id="totalOrders" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h3 class="font-semibold">ุทูุจุงุช ุชูุช ูุฑุงุฌุนุชูุง</h3>
        <p id="reviewedOrders" class="text-2xl font-bold text-green-600">0</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h3 class="font-semibold">ุทูุจุงุช ููุฏ ุงููุฑุงุฌุนุฉ</h3>
        <p id="pendingOrders" class="text-2xl font-bold text-yellow-600">0</p>
      </div>
    </div>
  </main>
  
  <script>
    // ---- CONFIG ----
    const sheetURL = "YOUR_GOOGLE_SHEET_URL"; // ุถุน ุฑุงุจุท Google Sheets
    const sheetName = "Sheet1"; 
    const apiURL = "YOUR_WEB_APP_URL"; // ุถุน ุฑุงุจุท Google Apps Script
    
    // ---- INITIALIZE ----
    window.addEventListener('DOMContentLoaded', init);
    
    function init() {
      // ุนุฑุถ ุงูุชุงุฑูุฎ ุงูุญุงูู
      document.getElementById('reportDate').textContent = new Date().toLocaleDateString('ar-SA');
      
      // ุชุญููู ุงูุจูุงูุงุช ูู Google Sheets
      Tabletop.init({
        key: sheetURL,
        simpleSheet: true,
        callback: showInfo
      });
      
      // ุชุญููู ุงูุจูุงูุงุช ุงููุญููุฉ ุฅุฐุง ูุฌุฏุช
      loadLocalData();
    }
    
    // ---- DISPLAY DATA ----
    function showInfo(data) {
      let tbody = document.getElementById("reportBody");
      tbody.innerHTML = "";
      
      data.forEach(row => {
        let tr = document.createElement("tr");
        tr.dataset.orderRef = row.OrderRef;
        
        // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ููุงู ุฑุฏ ูุณุฌู ูุญููุงู
        const localResponse = getLocalResponse(row.OrderRef);
        
        tr.innerHTML = `
          <td class="border px-2 py-1">${row.Date}</td>
          <td class="border px-2 py-1">${row.Location}</td>
          <td class="border px-2 py-1">${row.Aggregator}</td>
          <td class="border px-2 py-1">${row.OrderRef}</td>
          <td class="border px-2 py-1">${row.BillAmount}</td>
          <td class="border px-2 py-1">${row.FinalStatus}</td>
          <td class="border px-2 py-1 response-cell">
            <div class="responseText text-xs font-semibold ${localResponse.status === 'approved' ? 'text-green-600' : localResponse.status === 'rejected' ? 'text-red-600' : 'text-blue-600'}">
              ${localResponse.text || row.ManagerResponse || "ูู ูุชู ุงูุฑุฏ ุจุนุฏ"}
            </div>
          </td>
          <td class="border px-2 py-1">
            <button onclick="setResponse('${row.OrderRef}', 'approved', 'ููุงููุฉ โ')" 
                    class="bg-green-500 text-white px-2 py-1 rounded text-sm ${localResponse.status ? 'opacity-50' : ''}" 
                    ${localResponse.status ? 'disabled' : ''}>
              ููุงููุฉ
            </button>
            <button onclick="setResponse('${row.OrderRef}', 'rejected', 'ุฑูุถ โ')" 
                    class="bg-red-500 text-white px-2 py-1 rounded text-sm ${localResponse.status ? 'opacity-50' : ''}" 
                    ${localResponse.status ? 'disabled' : ''}>
              ุฑูุถ
            </button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
      
      updateStatistics();
    }
    
    // ---- RESPONSE HANDLING ----
    function setResponse(orderRef, status, text) {
      // ุชุญุฏูุซ ุงููุงุฌูุฉ
      const row = document.querySelector(`tr[data-order-ref="${orderRef}"]`);
      const responseDiv = row.querySelector('.responseText');
      responseDiv.innerText = text;
      responseDiv.className = `responseText text-xs font-semibold ${status === 'approved' ? 'text-green-600' : 'text-red-600'}`;
      
      // ุชุนุทูู ุงูุฃุฒุฑุงุฑ
      const buttons = row.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50');
      });
      
      // ุญูุธ ุงูุฑุฏ ูุญููุงู
      saveLocalResponse(orderRef, status, text);
      
      // ุฅุฑุณุงู ุงูุฑุฏ ุฅูู Google Sheets
      fetch(apiURL, {
        method: "POST",
        body: JSON.stringify({ orderRef: orderRef, response: text }),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.text())
      .then(msg => console.log("โ ุชู ุงูุญูุธ ูู Google Sheets:", msg))
      .catch(err => console.error("โ ุฎุทุฃ:", err));
      
      // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
      updateStatistics();
    }
    
    // ---- LOCAL STORAGE ----
    function saveLocalResponse(orderRef, status, text) {
      const responses = JSON.parse(localStorage.getItem('orderResponses') || '{}');
      responses[orderRef] = { status, text, date: new Date().toISOString() };
      localStorage.setItem('orderResponses', JSON.stringify(responses));
    }
    
    function getLocalResponse(orderRef) {
      const responses = JSON.parse(localStorage.getItem('orderResponses') || '{}');
      return responses[orderRef] || { status: null, text: '' };
    }
    
    function saveToLocal() {
      alert("โ ุชู ุญูุธ ุงูุชูุฑูุฑ ูุญููุงู ุจูุฌุงุญ");
    }
    
    function loadLocalData() {
      // ุณูุชู ุชุญููู ุงูุจูุงูุงุช ุงููุญููุฉ ุนูุฏ ุงูุญุงุฌุฉ
    }
    
    // ---- STATISTICS ----
    function updateStatistics() {
      const rows = document.querySelectorAll('#reportBody tr');
      let reviewed = 0;
      let pending = 0;
      
      rows.forEach(row => {
        const responseText = row.querySelector('.responseText').innerText;
        if (responseText && responseText !== "ูู ูุชู ุงูุฑุฏ ุจุนุฏ") {
          reviewed++;
        } else {
          pending++;
        }
      });
      
      document.getElementById('totalOrders').textContent = rows.length;
      document.getElementById('reviewedOrders').textContent = reviewed;
      document.getElementById('pendingOrders').textContent = pending;
    }
    
    // ---- SEND REPORT ----
    function sendReport() {
      const reviewedCount = document.getElementById('reviewedOrders').textContent;
      const pendingCount = document.getElementById('pendingOrders').textContent;
      
      if (pendingCount > 0) {
        if (!confirm(`ูุง ูุฒุงู ููุงู ${pendingCount} ุทูุจ ููุฏ ุงููุฑุงุฌุนุฉ. ูู ุชุฑูุฏ ุฅุฑุณุงู ุงูุชูุฑูุฑ ุนูู ุฃู ุญุงูุ`)) {
          return;
        }
      }
      
      // ููุง ููููู ุฅุถุงูุฉ ููุฏ ุฅุฑุณุงู ุงูุชูุฑูุฑ ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
      alert(`๐ง ุณูุชู ุฅุฑุณุงู ุงูุชูุฑูุฑ ุฅูู ุงููุฏูุฑ\nุงูุทูุจุงุช ุงููุฑุงุฌุนุฉ: ${reviewedCount}\nุงูุทูุจุงุช ุงููุนููุฉ: ${pendingCount}`);
      
      // ุจุนุฏ ุงูุฅุฑุณุงูุ ููููู ูุณุญ ุงูุจูุงูุงุช ุงููุญููุฉ ุฅุฐุง ุฃุฑุฏุช
      // localStorage.removeItem('orderResponses');
    }
  </script>
</body>
</html>
