<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام متابعة الطلبات الملغاة - Crispy Chicken</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .btn-primary { background-color: #dc2626; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; }
    .btn-secondary { background-color: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; }
    .btn-success { background-color: #16a34a; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; }
    .btn-warning { background-color: #f59e0b; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; }
    .stats-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 0.5rem;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    .stats-card:hover {
      transform: translateY(-5px);
    }
    .stats-number {
      font-size: 2rem;
      font-weight: bold;
      margin: 0.5rem 0;
    }
    .stats-label {
      font-size: 0.9rem;
      color: #4b5563;
    }
    .dashboard-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .dashboard-table th, .dashboard-table td {
      border: 1px solid #e5e7eb;
      padding: 0.75rem;
      text-align: center;
    }
    .dashboard-table th {
      background-color: #f9fafb;
      font-weight: 600;
    }
    .dashboard-table tr:nth-child(even) {
      background-color: #f9fafb;
    }
    .progress-bar {
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .progress-fill {
      height: 100%;
      background-color: #dc2626;
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: bold;
      margin-bottom: 1rem;
      color: #1f2937;
      border-bottom: 2px solid #dc2626;
      padding-bottom: 0.5rem;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s, transform 0.3s;
    }
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    .notification.success {
      background-color: #10b981;
    }
    .notification.error {
      background-color: #ef4444;
    }
    .notification.info {
      background-color: #3b82f6;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      border-radius: 0.5rem;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 2rem;
    }
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
    }
    .pagination button {
      margin: 0 5px;
      padding: 5px 10px;
      border: 1px solid #ddd;
      background-color: white;
      cursor: pointer;
      border-radius: 3px;
    }
    .pagination button.active {
      background-color: #dc2626;
      color: white;
      border-color: #dc2626;
    }
    .pagination button:hover:not(.active) {
      background-color: #f3f4f6;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab-button.active { background-color: #dc2626; color: white; }
    .form-input { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; }
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-weight: 500; margin-bottom: 0.25rem; color: #374151; }
    .filter-select {
      background-color: #dc2626;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      border: none;
      font-weight: 500;
    }
    .filter-section {
      background-color: #f9fafb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-red-600 p-4 text-white text-center">
    <h1 class="text-2xl font-bold">نظام متابعة الطلبات الملغاة - Crispy Chicken</h1>
    <p class="text-sm">نظام متكامل لإدارة التقارير والبيانات</p>
  </header>
  
  <main class="max-w-6xl mx-auto p-4">
    <!-- فلتر الاختيارات -->
    <div class="filter-section">
      <div class="flex flex-wrap items-center justify-between">
        <div class="flex items-center space-x-2 space-x-reverse">
          <i class="fas fa-filter text-red-600"></i>
          <span class="font-medium">اختر القسم:</span>
          <select id="sectionFilter" class="filter-select" onchange="showSection()">
            <option value="dashboard">داش بورد</option>
            <option value="reports">تقرير</option>
            <option value="dataEntry">ادخال</option>
            <option value="investigation">تحقيق</option>
            <option value="performance">اداء الخ</option>
          </select>
        </div>
        <div class="text-sm text-gray-600">
          التاريخ الميلادي: <span id="gregorianDate" class="font-medium"></span> | 
          التاريخ الهجري: <span id="hijriDate" class="font-medium"></span>
        </div>
      </div>
    </div>
    
    <!-- قسم داش بورد -->
    <div id="dashboardSection" class="tab-content active">
      <div class="bg-white rounded-lg shadow p-4 mb-4">
        <div class="flex flex-wrap justify-between items-center">
          <h2 class="text-lg font-semibold">لوحة التحكم</h2>
          <div class="flex flex-wrap gap-2">
            <button onclick="exportData()" class="btn-secondary">
              <i class="fas fa-file-export ml-1"></i> تصدير البيانات
            </button>
            <button onclick="generateDashboardReport()" class="btn-success">
              <i class="fas fa-chart-bar ml-1"></i> تقرير لوحة التحكم
            </button>
          </div>
        </div>
      </div>
      
      <!-- الإحصائيات العامة -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="stats-card">
          <i class="fas fa-clipboard-list text-2xl text-red-500"></i>
          <div class="stats-number" id="totalOrdersStat">0</div>
          <div class="stats-label">إجمالي الطلبات</div>
        </div>
        <div class="stats-card">
          <i class="fas fa-ban text-2xl text-red-500"></i>
          <div class="stats-number" id="cancelledOrdersStat">0</div>
          <div class="stats-label">طلبات ملغاة</div>
        </div>
        <div class="stats-card">
          <i class="fas fa-undo text-2xl text-blue-500"></i>
          <div class="stats-number" id="refundedOrdersStat">0</div>
          <div class="stats-label">طلبات مستردة</div>
        </div>
        <div class="stats-card">
          <i class="fas fa-exclamation-triangle text-2xl text-yellow-500"></i>
          <div class="stats-number" id="pendingOrdersStat">0</div>
          <div class="stats-label">طلبات عالقة</div>
        </div>
      </div>
      
      <!-- لوحة التحكم الديناميكية -->
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex flex-wrap gap-2 mb-4">
          <button class="tab-button active px-4 py-2 rounded-lg" onclick="showTab('channels')">
            <i class="fas fa-broadcast-tower ml-1"></i> القنوات
          </button>
          <button class="tab-button px-4 py-2 rounded-lg" onclick="showTab('branches')">
            <i class="fas fa-store ml-1"></i> الفروع
          </button>
          <button class="tab-button px-4 py-2 rounded-lg" onclick="showTab('trends')">
            <i class="fas fa-chart-line ml-1"></i> الاتجاهات
          </button>
        </div>
        
        <!-- محتوى تبويب القنوات -->
        <div id="channels-tab" class="tab-content active">
          <h3 class="section-title">لوحة تحكم القنوات</h3>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <div class="chart-container">
                <canvas id="channelChart"></canvas>
              </div>
            </div>
            <div>
              <div class="overflow-x-auto">
                <table class="dashboard-table">
                  <thead>
                    <tr>
                      <th>القناة</th>
                      <th>الطلبات الملغاة</th>
                      <th>الطلبات المستردة</th>
                      <th>الطلبات المتنازع عليها</th>
                      <th>الطلبات بدون رد</th>
                      <th>الإجمالي</th>
                      <th>نسبة الإلغاء</th>
                    </tr>
                  </thead>
                  <tbody id="channelTableBody">
                    <!-- سيتم تحميل البيانات هنا -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- محتوى تبويب الفروع -->
        <div id="branches-tab" class="tab-content">
          <h3 class="section-title">لوحة تحكم الفروع</h3>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <div class="chart-container">
                <canvas id="branchChart"></canvas>
              </div>
            </div>
            <div>
              <div class="overflow-x-auto">
                <table class="dashboard-table">
                  <thead>
                    <tr>
                      <th>الفرع</th>
                      <th>الطلبات الملغاة</th>
                      <th>الطلبات المستردة</th>
                      <th>الطلبات العالقة</th>
                      <th>الإجمالي</th>
                      <th>نسبة الإلغاء</th>
                      <th>جهة الاتصال</th>
                    </tr>
                  </thead>
                  <tbody id="branchTableBody">
                    <!-- سيتم تحميل البيانات هنا -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- محتوى تبويب الاتجاهات -->
        <div id="trends-tab" class="tab-content">
          <h3 class="section-title">اتجاهات الطلبات الملغاة</h3>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <div class="chart-container">
                <canvas id="trendChart"></canvas>
              </div>
            </div>
            <div>
              <div class="chart-container">
                <canvas id="statusChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- قسم التقارير -->
    <div id="reportsSection" class="tab-content">
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <h2 class="text-lg font-semibold mb-4">التقارير</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <h3 class="font-semibold text-lg mb-2">تقرير أداء القنوات والفروع</h3>
            <p class="text-gray-600 mb-4">تقرير شامل يوضح أداء جميع القنوات والفروع</p>
            <button onclick="generateDashboardReport()" class="btn-secondary">
              <i class="fas fa-chart-bar ml-1"></i> إنشاء التقرير
            </button>
          </div>
          
          <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <h3 class="font-semibold text-lg mb-2">تقرير الطلبات الملغاة</h3>
            <p class="text-gray-600 mb-4">تقرير مفصل لكل طلب ملغي مع إمكانية الإرسال</p>
            <button onclick="showCancelledOrdersReport()" class="btn-secondary">
              <i class="fas fa-file-alt ml-1"></i> عرض الطلبات
            </button>
          </div>
          
          <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            <h3 class="font-semibold text-lg mb-2">تقرير التحقيقات</h3>
            <p class="text-gray-600 mb-4">تقرير يوضح جميع التحقيقات الجارية</p>
            <button onclick="showInvestigationReport()" class="btn-secondary">
              <i class="fas fa-search ml-1"></i> عرض التحقيقات
            </button>
          </div>
          
          <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
            <h3 class="font-semibold text-lg mb-2">تقرير الأداء</h3>
            <p class="text-gray-600 mb-4">تقرير أداء الفروع والموظفين</p>
            <button onclick="showPerformanceReport()" class="btn-secondary">
              <i class="fas fa-tachometer-alt ml-1"></i> عرض الأداء
            </button>
          </div>
        </div>
      </div>
      
      <!-- جدول التقارير السابقة -->
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="section-title">التقارير السابقة</h3>
        <div class="overflow-x-auto">
          <table class="dashboard-table">
            <thead>
              <tr>
                <th>رقم التقرير</th>
                <th>النوع</th>
                <th>التاريخ</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="reportsTableBody">
              <tr>
                <td class="border px-2 py-1">#001</td>
                <td class="border px-2 py-1">تقرير أداء</td>
                <td class="border px-2 py-1">28/08/2025</td>
                <td class="border px-2 py-1">مكتمل</td>
                <td class="border px-2 py-1">
                  <button class="btn-secondary text-sm">عرض</button>
                  <button class="btn-success text-sm">إرسال</button>
                </td>
              </tr>
              <tr>
                <td class="border px-2 py-1">#002</td>
                <td class="border px-2 py-1">تحقيق</td>
                <td class="border px-2 py-1">27/08/2025</td>
                <td class="border px-2 py-1">قيد المعالجة</td>
                <td class="border px-2 py-1">
                  <button class="btn-secondary text-sm">عرض</button>
                  <button class="btn-warning text-sm">متابعة</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- قسم إدخال البيانات -->
    <div id="dataEntrySection" class="tab-content">
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <h2 class="text-lg font-semibold mb-4">إدخال بيانات الطلبات الملغاة</h2>
        <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label for="brand" class="form-label">العلامة التجارية</label>
            <select id="brand" class="form-input w-full" required>
              <option value="Crispy Chicken">Crispy Chicken</option>
            </select>
          </div>
          <div class="form-group">
            <label for="channel" class="form-label">القناة</label>
            <select id="channel" class="form-input w-full" required>
              <option value="Talabat">Talabat</option>
              <option value="Careem Now">Careem Now</option>
              <option value="Deliveroo">Deliveroo</option>
              <option value="Noon Food">Noon Food</option>
              <option value="Smiles">Smiles</option>
            </select>
          </div>
          <div class="form-group">
            <label for="location" class="form-label">الموقع</label>
            <select id="location" class="form-input w-full" required>
              <option value="Electra">Electra</option>
              <option value="Mouroor">Mouroor</option>
              <option value="Khalydiha">Khalydiha</option>
              <option value="Satwa">Satwa</option>
              <option value="Hamdan">Hamdan</option>
              <option value="Barsha">Barsha</option>
              <option value="Shabiha">Shabiha</option>
            </select>
          </div>
          <div class="form-group">
            <label for="status" class="form-label">الحالة</label>
            <select id="status" class="form-input w-full" required>
              <option value="Order Cancelled">Order Cancelled</option>
              <option value="Order Refunded">Order Refunded</option>
              <option value="Order Disputed">Order Disputed</option>
              <option value="Unanswered">Unanswered</option>
            </select>
          </div>
          <div class="form-group">
            <label for="price" class="form-label">السعر</label>
            <input type="text" id="price" class="form-input w-full" placeholder="AED 0.00" required>
          </div>
          <div class="form-group">
            <label for="orderCount" class="form-label">عدد الطلبات</label>
            <input type="number" id="orderCount" class="form-input w-full" min="1" value="1" required>
          </div>
          <div class="form-group md:col-span-2">
            <button type="submit" class="btn-primary w-full">
              <i class="fas fa-plus ml-1"></i> إضافة الطلب
            </button>
          </div>
        </form>
      </div>
      
      <!-- آخر الطلبات المدخلة -->
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="section-title">آخر الطلبات المدخلة</h3>
        <div class="overflow-x-auto">
          <table id="reportTable" class="w-full border text-center text-sm">
            <thead class="bg-red-100">
              <tr>
                <th class="border px-2 py-1">#</th>
                <th class="border px-2 py-1">العلامة التجارية</th>
                <th class="border px-2 py-1">القناة</th>
                <th class="border px-2 py-1">الموقع</th>
                <th class="border px-2 py-1">الحالة</th>
                <th class="border px-2 py-1">السعر</th>
                <th class="border px-2 py-1">عدد الطلبات</th>
                <th class="border px-2 py-1">التاريخ</th>
                <th class="border px-2 py-1">الإجراءات</th>
              </tr>
            </thead>
            <tbody id="reportBody">
              <!-- سيتم تحميل الصفوف من البيانات المدخلة -->
            </tbody>
          </table>
        </div>
        <div class="pagination" id="pagination">
          <!-- سيتم تحميل أزرار التصفح هنا -->
        </div>
      </div>
    </div>
    
    <!-- قسم التحقيق -->
    <div id="investigationSection" class="tab-content">
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <h2 class="text-lg font-semibold mb-4">التحقيقات الجارية</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">التحقيقات العاجلة</h3>
              <span class="bg-red-600 text-white px-2 py-1 rounded-full text-sm">3</span>
            </div>
            <p class="text-gray-600 mb-3">التحقيقات التي تتطلب تدخل فوري</p>
            <div class="space-y-2">
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>طلب #12345 - Talabat</span>
                <span class="text-red-600 font-medium">معلق منذ يومين</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>طلب #12346 - Careem</span>
                <span class="text-red-600 font-medium">معلق منذ يوم</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>طلب #12347 - Noon</span>
                <span class="text-red-600 font-medium">معلق منذ 3 أيام</span>
              </div>
            </div>
          </div>
          
          <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">التحقيقات قيد المعالجة</h3>
              <span class="bg-yellow-600 text-white px-2 py-1 rounded-full text-sm">5</span>
            </div>
            <p class="text-gray-600 mb-3">التحقيقات التي جاري العمل عليها</p>
            <div class="space-y-2">
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>طلب #12348 - Talabat</span>
                <span class="text-yellow-600 font-medium">قيد المراجعة</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>طلب #12349 - Deliveroo</span>
                <span class="text-yellow-600 font-medium">انتظار الرد</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h3 class="section-title">بدء تحقيق جديد</h3>
          <form class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="form-group">
              <label class="form-label">رقم الطلب</label>
              <input type="text" class="form-input" placeholder="أدخل رقم الطلب">
            </div>
            <div class="form-group">
              <label class="form-label">سبب التحقيق</label>
              <select class="form-input">
                <option>إلغاء غير مبرر</option>
                <option>تأخير في التسليم</option>
                <option>مشكلة في الدفع</option>
                <option>أخرى</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">الأولوية</label>
              <select class="form-input">
                <option>عاجل</option>
                <option>متوسط</option>
                <option>منخفض</option>
              </select>
            </div>
            <div class="form-group md:col-span-3">
              <label class="form-label">ملاحظات إضافية</label>
              <textarea class="form-input w-full" rows="3" placeholder="أدخل أي ملاحظات إضافية"></textarea>
            </div>
            <div class="form-group md:col-span-3">
              <button type="button" class="btn-primary" onclick="startNewInvestigation()">
                <i class="fas fa-plus ml-1"></i> بدء التحقيق
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- جدول التحقيقات -->
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="section-title">سجل التحقيقات</h3>
        <div class="overflow-x-auto">
          <table class="dashboard-table">
            <thead>
              <tr>
                <th>رقم التحقيق</th>
                <th>رقم الطلب</th>
                <th>القناة</th>
                <th>الفرع</th>
                <th>السبب</th>
                <th>الحالة</th>
                <th>التاريخ</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border px-2 py-1">#INV001</td>
                <td class="border px-2 py-1">#12345</td>
                <td class="border px-2 py-1">Talabat</td>
                <td class="border px-2 py-1">Electra</td>
                <td class="border px-2 py-1">إلغاء غير مبرر</td>
                <td class="border px-2 py-1"><span class="bg-red-600 text-white px-2 py-1 rounded text-xs">عاجل</span></td>
                <td class="border px-2 py-1">28/08/2025</td>
                <td class="border px-2 py-1">
                  <button class="btn-secondary text-sm mr-1">عرض</button>
                  <button class="btn-success text-sm">تحديث</button>
                </td>
              </tr>
              <tr>
                <td class="border px-2 py-1">#INV002</td>
                <td class="border px-2 py-1">#12346</td>
                <td class="border px-2 py-1">Careem</td>
                <td class="border px-2 py-1">Mouroor</td>
                <td class="border px-2 py-1">تأخير في التسليم</td>
                <td class="border px-2 py-1"><span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">قيد المعالجة</span></td>
                <td class="border px-2 py-1">27/08/2025</td>
                <td class="border px-2 py-1">
                  <button class="btn-secondary text-sm mr-1">عرض</button>
                  <button class="btn-warning text-sm">متابعة</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- قسم الأداء -->
    <div id="performanceSection" class="tab-content">
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <h2 class="text-lg font-semibold mb-4">تقرير الأداء</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">أفضل الأداء</h3>
              <i class="fas fa-trophy text-green-600 text-xl"></i>
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>فرع Electra</span>
                <span class="text-green-600 font-medium">98% معدل رضا</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>فرع Khalydiha</span>
                <span class="text-green-600 font-medium">96% معدل رضا</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>فرع Satwa</span>
                <span class="text-green-600 font-medium">95% معدل رضا</span>
              </div>
            </div>
          </div>
          
          <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">يحتاج تحسين</h3>
              <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>فرع Barsha</span>
                <span class="text-red-600 font-medium">78% معدل رضا</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>فرع Shabiha</span>
                <span class="text-red-600 font-medium">82% معدل رضا</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>فرع Hamdan</span>
                <span class="text-red-600 font-medium">85% معدل رضا</span>
              </div>
            </div>
          </div>
          
          <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">متوسط الأداء</h3>
              <i class="fas fa-minus text-blue-600 text-xl"></i>
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>فرع Mouroor</span>
                <span class="text-blue-600 font-medium">90% معدل رضا</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>قناة Talabat</span>
                <span class="text-blue-600 font-medium">88% معدل رضا</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white rounded">
                <span>قناة Noon</span>
                <span class="text-blue-600 font-medium">92% معدل رضا</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h3 class="section-title">مؤشرات الأداء</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <div class="chart-container">
                <canvas id="performanceChart"></canvas>
              </div>
            </div>
            <div>
              <div class="chart-container">
                <canvas id="satisfactionChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- جدول الأداء -->
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="section-title">تفاصيل الأداء</h3>
        <div class="overflow-x-auto">
          <table class="dashboard-table">
            <thead>
              <tr>
                <th>الفرع/القناة</th>
                <th>عدد الطلبات</th>
                <th>الطلبات الملغاة</th>
                <th>نسبة الإلغاء</th>
                <th>معدل الرضا</th>
                <th>التقييم</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border px-2 py-1">Electra</td>
                <td class="border px-2 py-1">245</td>
                <td class="border px-2 py-1">12</td>
                <td class="border px-2 py-1">4.9%</td>
                <td class="border px-2 py-1">98%</td>
                <td class="border px-2 py-1"><span class="text-green-600 font-medium">ممتاز</span></td>
                <td class="border px-2 py-1">
                  <button class="btn-secondary text-sm">تفاصيل</button>
                </td>
              </tr>
              <tr>
                <td class="border px-2 py-1">Mouroor</td>
                <td class="border px-2 py-1">198</td>
                <td class="border px-2 py-1">18</td>
                <td class="border px-2 py-1">9.1%</td>
                <td class="border px-2 py-1">90%</td>
                <td class="border px-2 py-1"><span class="text-blue-600 font-medium">جيد</span></td>
                <td class="border px-2 py-1">
                  <button class="btn-secondary text-sm">تفاصيل</button>
                </td>
              </tr>
              <tr>
                <td class="border px-2 py-1">Barsha</td>
                <td class="border px-2 py-1">156</td>
                <td class="border px-2 py-1">32</td>
                <td class="border px-2 py-1">20.5%</td>
                <td class="border px-2 py-1">78%</td>
                <td class="border px-2 py-1"><span class="text-red-600 font-medium">ضعيف</span></td>
                <td class="border px-2 py-1">
                  <button class="btn-warning text-sm">تحسين</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- التقرير الرسمي والرسالة الجاهزة -->
    <div id="detailedReport" class="hidden">
      <!-- التقرير الرسمي -->
      <div class="bg-white rounded-lg shadow p-4 mb-4">
        <div class="text-center mb-4">
          <h2 class="text-xl font-bold">تقرير إلغاء طلب — Crispy Chicken</h2>
          <div class="flex justify-center space-x-8 mt-2">
            <p>فرع: <span id="reportBranch" class="font-semibold">-</span></p>
            <p>قناة: <span id="reportChannel" class="font-semibold">-</span></p>
            <p>الحالة: <span id="reportStatus" class="font-semibold">-</span></p>
            <p>السعر: <span id="reportPrice" class="font-semibold">-</span></p>
            <p>عدد الطلبات: <span id="reportOrderCount" class="font-semibold">-</span></p>
          </div>
        </div>
        
        <div class="mb-6">
          <h3 class="section-title">الأسئلة المطلوب التأكد منها</h3>
          <div class="space-y-3">
            <div class="flex items-center p-2 bg-gray-50 rounded">
              <span class="font-medium ml-2 w-48">1) هل تم تسليم الطلب؟</span>
              <div class="flex-grow border-b border-gray-300"></div>
            </div>
            <div class="flex items-center p-2 bg-gray-50 rounded">
              <span class="font-medium ml-2 w-48">2) هل الإلغاء بإرادتك؟</span>
              <div class="flex-grow border-b border-gray-300"></div>
            </div>
            <div class="flex items-center p-2 bg-gray-50 rounded">
              <span class="font-medium ml-2 w-48">3) هل لديك إثبات لذلك؟</span>
              <div class="flex-grow border-b border-gray-300"></div>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h3 class="section-title">التأثير:</h3>
          <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            <p class="text-gray-700">الإلغاء قد يؤدي إلى خصومات مالية من الطرفين (مثل دفع قيمة الطعام أو رسوم التحضير)، لذا التأكيد والتوثيق ضروري.</p>
          </div>
        </div>
        
        <div class="mb-6">
          <h3 class="section-title">الخطوات التالية:</h3>
          <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <ul class="list-disc pr-5 space-y-2 text-gray-700">
              <li>إرسال إشعار للعميل</li>
              <li>انتظار الرد</li>
              <li>مراجعة الإجراءات المالية</li>
              <li>أرشفة المستندات</li>
            </ul>
          </div>
        </div>
        
        <div class="flex justify-between mt-8 pt-4 border-t">
          <div>
            <p>تم إعداد التقرير بواسطة: ______________</p>
          </div>
          <div>
            <p>التاريخ: ___________</p>
          </div>
        </div>
      </div>
      
      <!-- خيارات الإرسال والطباعة -->
      <div class="flex flex-wrap gap-3 mb-4">
        <button onclick="window.print()" class="btn-secondary">
          <i class="fas fa-print ml-1"></i> طباعة التقرير
        </button>
        <button onclick="exportToPDF()" class="btn-secondary">
          <i class="fas fa-file-pdf ml-1"></i> تصدير PDF
        </button>
        <button onclick="sendReportEmail()" class="btn-success">
          <i class="fas fa-envelope ml-1"></i> إرسال بالبريد
        </button>
        <button onclick="sendReportWhatsApp()" class="btn-success">
          <i class="fab fa-whatsapp ml-1"></i> إرسال بواسطة WhatsApp
        </button>
      </div>
      
      <!-- رسالة WhatsApp جاهزة -->
      <div class="bg-green-50 rounded-lg shadow p-4 border border-green-200">
        <h3 class="section-title">رسالة WhatsApp جاهزة للإرسال</h3>
        <div class="mb-3">
          <button onclick="copyWhatsAppMessage()" class="btn-success">
            <i class="fab fa-whatsapp ml-1"></i> نسخ الرسالة
          </button>
        </div>
        <textarea id="whatsappMessage" class="w-full h-40 p-2 border rounded" readonly></textarea>
        <p class="text-sm text-gray-600 mt-2">يمكنك نسخ هذه الرسالة ولصقها في WhatsApp وإرسالها للعميل</p>
      </div>
    </div>
  </main>
  
  <!-- نافذة إدخال البيانات -->
  <div id="dataEntryModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeDataEntryModal()">&times;</span>
      <h2 class="section-title">إدخال بيانات الطلبات الملغاة</h2>
      <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-group">
          <label for="brand" class="form-label">العلامة التجارية</label>
          <select id="brand" class="form-input w-full" required>
            <option value="Crispy Chicken">Crispy Chicken</option>
          </select>
        </div>
        <div class="form-group">
          <label for="channel" class="form-label">القناة</label>
          <select id="channel" class="form-input w-full" required>
            <option value="Talabat">Talabat</option>
            <option value="Careem Now">Careem Now</option>
            <option value="Deliveroo">Deliveroo</option>
            <option value="Noon Food">Noon Food</option>
            <option value="Smiles">Smiles</option>
          </select>
        </div>
        <div class="form-group">
          <label for="location" class="form-label">الموقع</label>
          <select id="location" class="form-input w-full" required>
            <option value="Electra">Electra</option>
            <option value="Mouroor">Mouroor</option>
            <option value="Khalydiha">Khalydiha</option>
            <option value="Satwa">Satwa</option>
            <option value="Hamdan">Hamdan</option>
            <option value="Barsha">Barsha</option>
            <option value="Shabiha">Shabiha</option>
          </select>
        </div>
        <div class="form-group">
          <label for="status" class="form-label">الحالة</label>
          <select id="status" class="form-input w-full" required>
            <option value="Order Cancelled">Order Cancelled</option>
            <option value="Order Refunded">Order Refunded</option>
            <option value="Order Disputed">Order Disputed</option>
            <option value="Unanswered">Unanswered</option>
          </select>
        </div>
        <div class="form-group">
          <label for="price" class="form-label">السعر</label>
          <input type="text" id="price" class="form-input w-full" placeholder="AED 0.00" required>
        </div>
        <div class="form-group">
          <label for="orderCount" class="form-label">عدد الطلبات</label>
          <input type="number" id="orderCount" class="form-input w-full" min="1" value="1" required>
        </div>
        <div class="form-group md:col-span-2">
          <button type="submit" class="btn-primary w-full">
            <i class="fas fa-plus ml-1"></i> إضافة الطلب
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // ---- DATA STORAGE ----
    let orders = [];
    let currentPage = 1;
    const ordersPerPage = 15;
    
    // ---- CONTACTS DATA ----
    const contacts = {
      branches: {
        Electra: { phone: "+971 56 386 6859", email: "" },
        Muroor: { phone: "+971 50 541 4641", email: "" },
        Khaldiha: { phone: "+971 56 949 4764", email: "" },
        Satwa: { phone: "+971 56 797 0685", email: "" },
        Hamdan: { phone: "+971 55 688 6650", email: "" },
        Barsha: { phone: "+971 56 965 9524", email: "" },
        Shabiha: { phone: "+971 56 269 0688", email: "" }
      },
      management: {
        "GM Tayser": { phone: "+971 54 445 4799", email: "" },
        "Mr. Mahmoud Shaheen": { phone: "+971 50 364 3659", email: "mshahin76@yahoo.com" },
        "Mohammed T": { phone: "", email: "mohammed.t@crispychicken.rest" }
      }
    };
    
    // ---- CHANNEL COLORS ----
    const channelColors = {
      "Talabat": "#F97316",
      "Careem Now": "#10B981",
      "Deliveroo": "#3B82F6",
      "Noon Food": "#8B5CF6",
      "Smiles": "#EC4899"
    };
    
    // ---- BRANCH COLORS ----
    const branchColors = {
      "Electra": "#EF4444",
      "Mouroor": "#F59E0B",
      "Khaldiha": "#10B981",
      "Satwa": "#3B82F6",
      "Hamdan": "#8B5CF6",
      "Barsha": "#EC4899",
      "Shabiha": "#6366F1"
    };
    
    // ---- CHARTS ----
    let channelChart, branchChart, trendChart, statusChart, performanceChart, satisfactionChart;
    
    // ---- INITIALIZE ----
    window.addEventListener('DOMContentLoaded', init);
    
    function init() {
      // عرض التواريخ
      updateDates();
      
      // تحميل البيانات من التخزين المحلي
      loadData();
      
      // إعداد نموذج الإدخال
      document.getElementById('orderForm').addEventListener('submit', handleFormSubmit);
      
      // تحديث لوحات التحكم
      updateDashboards();
      updateGeneralStats();
      displayOrders();
      initializeCharts();
    }
    
    // ---- UPDATE DATES ----
    function updateDates() {
      const now = new Date();
      
      // التاريخ الميلادي
      document.getElementById('gregorianDate').textContent = now.toLocaleDateString('ar-SA');
      
      // التاريخ الهجري (تقريبي)
      const hijriDate = new Intl.DateTimeFormat('ar-SA', {
        calendar: 'islamic',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      }).format(now);
      document.getElementById('hijriDate').textContent = hijriDate;
    }
    
    // ---- LOAD DATA ----
    function loadData() {
      const savedData = localStorage.getItem('cancelledOrders');
      if (savedData) {
        orders = JSON.parse(savedData);
      }
    }
    
    // ---- SAVE DATA ----
    function saveData() {
      localStorage.setItem('cancelledOrders', JSON.stringify(orders));
    }
    
    // ---- SHOW SECTION ----
    function showSection() {
      const section = document.getElementById('sectionFilter').value;
      
      // إخفاء جميع الأقسام
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // إظهار القسم المحدد
      document.getElementById(section + 'Section').classList.add('active');
    }
    
    // ---- HANDLE FORM SUBMIT ----
    function handleFormSubmit(e) {
      e.preventDefault();
      
      const order = {
        id: Date.now(),
        brand: document.getElementById('brand').value,
        channel: document.getElementById('channel').value,
        location: document.getElementById('location').value,
        status: document.getElementById('status').value,
        price: document.getElementById('price').value,
        orderCount: parseInt(document.getElementById('orderCount').value),
        date: new Date().toISOString()
      };
      
      orders.push(order);
      saveData();
      displayOrders();
      updateDashboards();
      updateGeneralStats();
      updateCharts();
      
      // إعادة تعيين النموذج
      document.getElementById('orderForm').reset();
      document.getElementById('orderCount').value = 1;
      
      // إظهار رسالة نجاح
      showNotification('تمت إضافة الطلب بنجاح', 'success');
    }
    
    // ---- DISPLAY ORDERS ----
    function displayOrders() {
      const tbody = document.getElementById('reportBody');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      // حساب الصفحات
      const totalPages = Math.ceil(orders.length / ordersPerPage);
      const startIndex = (currentPage - 1) * ordersPerPage;
      const endIndex = startIndex + ordersPerPage;
      const paginatedOrders = orders.slice(startIndex, endIndex);
      
      // عرض الطلبات في الصفحة الحالية
      paginatedOrders.forEach((order, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-2 py-1">${startIndex + index + 1}</td>
          <td class="border px-2 py-1">${order.brand}</td>
          <td class="border px-2 py-1">${order.channel}</td>
          <td class="border px-2 py-1">${order.location}</td>
          <td class="border px-2 py-1">${order.status}</td>
          <td class="border px-2 py-1">${order.price}</td>
          <td class="border px-2 py-1">${order.orderCount}</td>
          <td class="border px-2 py-1">${new Date(order.date).toLocaleDateString('ar-SA')}</td>
          <td class="border px-2 py-1">
            <button onclick="generateDetailedReport(${order.id})" class="btn-secondary text-sm mr-1">
              <i class="fas fa-file-alt"></i>
            </button>
            <button onclick="deleteOrder(${order.id})" class="bg-red-500 text-white px-2 py-1 rounded text-sm">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      // تحديث أزرار التصفح
      updatePagination(totalPages);
    }
    
    // ---- UPDATE PAGINATION ----
    function updatePagination(totalPages) {
      const pagination = document.getElementById('pagination');
      if (!pagination) return;
      
      pagination.innerHTML = '';
      
      // زر السابق
      const prevButton = document.createElement('button');
      prevButton.textContent = 'السابق';
      prevButton.disabled = currentPage === 1;
      prevButton.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          displayOrders();
        }
      };
      pagination.appendChild(prevButton);
      
      // أرقام الصفحات
      for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        pageButton.className = i === currentPage ? 'active' : '';
        pageButton.onclick = () => {
          currentPage = i;
          displayOrders();
        };
        pagination.appendChild(pageButton);
      }
      
      // زر التالي
      const nextButton = document.createElement('button');
      nextButton.textContent = 'التالي';
      nextButton.disabled = currentPage === totalPages;
      nextButton.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          displayOrders();
        }
      };
      pagination.appendChild(nextButton);
    }
    
    // ---- UPDATE GENERAL STATS ----
    function updateGeneralStats() {
      const totalOrders = orders.reduce((sum, order) => sum + order.orderCount, 0);
      const cancelledOrders = orders.filter(order => order.status === 'Order Cancelled').reduce((sum, order) => sum + order.orderCount, 0);
      const refundedOrders = orders.filter(order => order.status === 'Order Refunded').reduce((sum, order) => sum + order.orderCount, 0);
      const pendingOrders = orders.filter(order => order.status === 'Order Disputed' || order.status === 'Unanswered').reduce((sum, order) => sum + order.orderCount, 0);
      
      document.getElementById('totalOrdersStat').textContent = totalOrders;
      document.getElementById('cancelledOrdersStat').textContent = cancelledOrders;
      document.getElementById('refundedOrdersStat').textContent = refundedOrders;
      document.getElementById('pendingOrdersStat').textContent = pendingOrders;
    }
    
    // ---- UPDATE DASHBOARDS ----
    function updateDashboards() {
      updateChannelDashboard();
      updateBranchDashboard();
    }
    
    // ---- UPDATE CHANNEL DASHBOARD ----
    function updateChannelDashboard() {
      const tbody = document.getElementById('channelTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      // حساب الإحصائيات لكل قناة
      const channels = ["Talabat", "Careem Now", "Deliveroo", "Noon Food", "Smiles"];
      
      channels.forEach(channel => {
        const channelOrders = orders.filter(order => order.channel === channel);
        const cancelled = channelOrders.filter(order => order.status === 'Order Cancelled').reduce((sum, order) => sum + order.orderCount, 0);
        const refunded = channelOrders.filter(order => order.status === 'Order Refunded').reduce((sum, order) => sum + order.orderCount, 0);
        const disputed = channelOrders.filter(order => order.status === 'Order Disputed').reduce((sum, order) => sum + order.orderCount, 0);
        const unanswered = channelOrders.filter(order => order.status === 'Unanswered').reduce((sum, order) => sum + order.orderCount, 0);
        const total = channelOrders.reduce((sum, order) => sum + order.orderCount, 0);
        
        // حساب نسبة الإلغاء
        const cancellationRate = total > 0 ? ((cancelled / total) * 100).toFixed(1) : 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-2 py-1 font-medium">${channel}</td>
          <td class="border px-2 py-1">${cancelled}</td>
          <td class="border px-2 py-1">${refunded}</td>
          <td class="border px-2 py-1">${disputed}</td>
          <td class="border px-2 py-1">${unanswered}</td>
          <td class="border px-2 py-1 font-bold">${total}</td>
          <td class="border px-2 py-1">
            <div class="flex items-center">
              <span class="ml-1">${cancellationRate}%</span>
              <div class="progress-bar flex-grow">
                <div class="progress-fill" style="width: ${cancellationRate}%"></div>
              </div>
            </div>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }
    
    // ---- UPDATE BRANCH DASHBOARD ----
    function updateBranchDashboard() {
      const tbody = document.getElementById('branchTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      // حساب الإحصائيات لكل فرع
      const branches = ["Electra", "Mouroor", "Khalydiha", "Satwa", "Hamdan", "Barsha", "Shabiha"];
      
      branches.forEach(branch => {
        const branchOrders = orders.filter(order => order.location === branch);
        const cancelled = branchOrders.filter(order => order.status === 'Order Cancelled').reduce((sum, order) => sum + order.orderCount, 0);
        const refunded = branchOrders.filter(order => order.status === 'Order Refunded').reduce((sum, order) => sum + order.orderCount, 0);
        const pending = branchOrders.filter(order => order.status === 'Order Disputed' || order.status === 'Unanswered').reduce((sum, order) => sum + order.orderCount, 0);
        const total = branchOrders.reduce((sum, order) => sum + order.orderCount, 0);
        
        // حساب نسبة الإلغاء
        const cancellationRate = total > 0 ? ((cancelled / total) * 100).toFixed(1) : 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-2 py-1 font-medium">${branch}</td>
          <td class="border px-2 py-1">${cancelled}</td>
          <td class="border px-2 py-1">${refunded}</td>
          <td class="border px-2 py-1">${pending}</td>
          <td class="border px-2 py-1 font-bold">${total}</td>
          <td class="border px-2 py-1">
            <div class="flex items-center">
              <span class="ml-1">${cancellationRate}%</span>
              <div class="progress-bar flex-grow">
                <div class="progress-fill" style="width: ${cancellationRate}%"></div>
              </div>
            </div>
          </td>
          <td class="border px-2 py-1">
            <a href="https://wa.me/${contacts.branches[branch].phone.replace(/[^0-9]/g, '')}" target="_blank" class="text-green-600">
              <i class="fab fa-whatsapp"></i>
            </a>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }
    
    // ---- INITIALIZE CHARTS ----
    function initializeCharts() {
      // إعداد الرسوم البيانية
      const channelCtx = document.getElementById('channelChart');
      const branchCtx = document.getElementById('branchChart');
      const trendCtx = document.getElementById('trendChart');
      const statusCtx = document.getElementById('statusChart');
      const performanceCtx = document.getElementById('performanceChart');
      const satisfactionCtx = document.getElementById('satisfactionChart');
      
      if (!channelCtx || !branchCtx || !trendCtx || !statusCtx || !performanceCtx || !satisfactionCtx) return;
      
      // رسم بياني للقنوات
      channelChart = new Chart(channelCtx, {
        type: 'bar',
        data: {
          labels: ['Talabat', 'Careem Now', 'Deliveroo', 'Noon Food', 'Smiles'],
          datasets: [{
            label: 'الطلبات الملغاة',
            data: [0, 0, 0, 0, 0],
            backgroundColor: channelColors["Talabat"]
          }, {
            label: 'الطلبات المستردة',
            data: [0, 0, 0, 0, 0],
            backgroundColor: channelColors["Careem Now"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'إحصائيات القنوات'
            }
          }
        }
      });
      
      // رسم بياني للفروع
      branchChart = new Chart(branchCtx, {
        type: 'bar',
        data: {
          labels: ['Electra', 'Mouroor', 'Khalydiha', 'Satwa', 'Hamdan', 'Barsha', 'Shabiha'],
          datasets: [{
            label: 'الطلبات الملغاة',
            data: [0, 0, 0, 0, 0, 0, 0],
            backgroundColor: branchColors["Electra"]
          }, {
            label: 'الطلبات المستردة',
            data: [0, 0, 0, 0, 0, 0, 0],
            backgroundColor: branchColors["Mouroor"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'إحصائيات الفروع'
            }
          }
        }
      });
      
      // رسم بياني للاتجاهات
      trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'الطلبات الملغاة',
            data: [],
            borderColor: '#dc2626',
            backgroundColor: 'rgba(220, 38, 38, 0.1)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'اتجاهات الطلبات الملغاة'
            }
          }
        }
      });
      
      // رسم بياني للحالات
      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['ملغاة', 'مستردة', 'متنازع عليها', 'بدون رد'],
          datasets: [{
            data: [0, 0, 0, 0],
            backgroundColor: ['#dc2626', '#2563eb', '#f59e0b', '#6b7280']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'توزيع الحالات'
            }
          }
        }
      });
      
      // رسم بياني للأداء
      performanceChart = new Chart(performanceCtx, {
        type: 'bar',
        data: {
          labels: ['Electra', 'Mouroor', 'Khalydiha', 'Satwa', 'Hamdan', 'Barsha', 'Shabiha'],
          datasets: [{
            label: 'نسبة الإلغاء',
            data: [4.9, 9.1, 3.2, 2.8, 5.6, 20.5, 8.3],
            backgroundColor: '#dc2626'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'نسب الإلغاء حسب الفرع'
            }
          }
        }
      });
      
      // رسم بياني لمعدل الرضا
      satisfactionChart = new Chart(satisfactionCtx, {
        type: 'bar',
        data: {
          labels: ['Electra', 'Mouroor', 'Khalydiha', 'Satwa', 'Hamdan', 'Barsha', 'Shabiha'],
          datasets: [{
            label: 'معدل الرضا',
            data: [98, 90, 96, 95, 85, 78, 82],
            backgroundColor: '#16a34a'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'معدل الرضا حسب الفرع'
            }
          }
        }
      });
      
      // تحديث الرسوم البيانية
      updateCharts();
    }
    
    // ---- UPDATE CHARTS ----
    function updateCharts() {
      if (!channelChart || !branchChart || !trendChart || !statusChart || !performanceChart || !satisfactionChart) return;
      
      // تحديث بيانات القنوات
      const channels = ["Talabat", "Careem Now", "Deliveroo", "Noon Food", "Smiles"];
      const channelCancelled = channels.map(channel => 
        orders.filter(order => order.channel === channel && order.status === 'Order Cancelled')
          .reduce((sum, order) => sum + order.orderCount, 0)
      );
      const channelRefunded = channels.map(channel => 
        orders.filter(order => order.channel === channel && order.status === 'Order Refunded')
          .reduce((sum, order) => sum + order.orderCount, 0)
      );
      
      channelChart.data.datasets[0].data = channelCancelled;
      channelChart.data.datasets[1].data = channelRefunded;
      channelChart.update();
      
      // تحديث بيانات الفروع
      const branches = ["Electra", "Mouroor", "Khalydiha", "Satwa", "Hamdan", "Barsha", "Shabiha"];
      const branchCancelled = branches.map(branch => 
        orders.filter(order => order.location === branch && order.status === 'Order Cancelled')
          .reduce((sum, order) => sum + order.orderCount, 0)
      );
      const branchRefunded = branches.map(branch => 
        orders.filter(order => order.location === branch && order.status === 'Order Refunded')
          .reduce((sum, order) => sum + order.orderCount, 0)
      );
      
      branchChart.data.datasets[0].data = branchCancelled;
      branchChart.data.datasets[1].data = branchRefunded;
      branchChart.update();
      
      // تحديث بيانات الاتجاهات (آخر 7 أيام)
      const last7Days = [];
      const trendData = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toLocaleDateString('ar-SA');
        last7Days.push(dateStr);
        
        const dayOrders = orders.filter(order => {
          const orderDate = new Date(order.date);
          return orderDate.toDateString() === date.toDateString();
        });
        
        trendData.push(dayOrders.reduce((sum, order) => sum + order.orderCount, 0));
      }
      
      trendChart.data.labels = last7Days;
      trendChart.data.datasets[0].data = trendData;
      trendChart.update();
      
      // تحديث بيانات الحالات
      const statusCancelled = orders.filter(order => order.status === 'Order Cancelled')
        .reduce((sum, order) => sum + order.orderCount, 0);
      const statusRefunded = orders.filter(order => order.status === 'Order Refunded')
        .reduce((sum, order) => sum + order.orderCount, 0);
      const statusDisputed = orders.filter(order => order.status === 'Order Disputed')
        .reduce((sum, order) => sum + order.orderCount, 0);
      const statusUnanswered = orders.filter(order => order.status === 'Unanswered')
        .reduce((sum, order) => sum + order.orderCount, 0);
      
      statusChart.data.datasets[0].data = [statusCancelled, statusRefunded, statusDisputed, statusUnanswered];
      statusChart.update();
    }
    
    // ---- DELETE ORDER ----
    function deleteOrder(id) {
      if (confirm('هل تريد حذف هذا الطلب؟')) {
        orders = orders.filter(order => order.id !== id);
        saveData();
        displayOrders();
        updateDashboards();
        updateGeneralStats();
        updateCharts();
        showNotification('تم حذف الطلب بنجاح', 'success');
      }
    }
    
    // ---- EXPORT DATA ----
    function exportData() {
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "BRAND,CHANNEL,LOCATION,STATUS,ORDER PRICE,NUMBER OF ORDERS,DATE\n";
      
      orders.forEach(order => {
        csvContent += `${order.brand},${order.channel},${order.location},${order.status},${order.price},${order.orderCount},${new Date(order.date).toLocaleDateString('ar-SA')}\n`;
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `cancelled_orders_${new Date().toISOString().slice(0, 10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification('تم تصدير البيانات بنجاح', 'success');
    }
    
    // ---- GENERATE DASHBOARD REPORT ----
    function generateDashboardReport() {
      // إنشاء تقرير لوحة التحكم
      const reportContent = `
        <div class="bg-white p-6 rounded-lg shadow-lg">
          <h2 class="text-2xl font-bold text-center mb-6">تقرير أداء القنوات والفروع</h2>
          <p class="text-center mb-4">التاريخ: ${new Date().toLocaleDateString('ar-SA')}</p>
          
          <div class="mb-8">
            <h3 class="text-xl font-bold mb-4 border-b pb-2">تقرير أداء القنوات</h3>
            <div class="overflow-x-auto">
              <table class="dashboard-table w-full">
                <thead>
                  <tr>
                    <th>القناة</th>
                    <th>الطلبات الملغاة</th>
                    <th>الطلبات المستردة</th>
                    <th>الطلبات المتنازع عليها</th>
                    <th>الطلبات بدون رد</th>
                    <th>الإجمالي</th>
                    <th>نسبة الإلغاء</th>
                  </tr>
                </thead>
                <tbody>
                  ${generateChannelReportRows()}
                </tbody>
              </table>
            </div>
          </div>
          
          <div>
            <h3 class="text-xl font-bold mb-4 border-b pb-2">تقرير أداء الفروع</h3>
            <div class="overflow-x-auto">
              <table class="dashboard-table w-full">
                <thead>
                  <tr>
                    <th>الفرع</th>
                    <th>الطلبات الملغاة</th>
                    <th>الطلبات المستردة</th>
                    <th>الطلبات العالقة</th>
                    <th>الإجمالي</th>
                    <th>نسبة الإلغاء</th>
                  </tr>
                </thead>
                <tbody>
                  ${generateBranchReportRows()}
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="mt-8 text-center">
            <p>تم إعداد التقرير بواسطة: ______________</p>
            <p>التاريخ: ___________</p>
          </div>
        </div>
      `;
      
      // عرض التقرير في نافذة جديدة
      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(`
        <html>
        <head>
          <title>تقرير أداء القنوات والفروع</title>
          <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
          <script src="https://cdn.tailwindcss.com"></script>
          <style>
            body { font-family: 'Tajawal', sans-serif; }
            .dashboard-table {
              width: 100%;
              border-collapse: collapse;
              margin-top: 1rem;
            }
            .dashboard-table th, .dashboard-table td {
              border: 1px solid #e5e7eb;
              padding: 0.75rem;
              text-align: center;
            }
            .dashboard-table th {
              background-color: #f9fafb;
              font-weight: 600;
            }
            .dashboard-table tr:nth-child(even) {
              background-color: #f9fafb;
            }
            .progress-bar {
              height: 8px;
              background-color: #e5e7eb;
              border-radius: 4px;
              overflow: hidden;
              margin-top: 0.5rem;
            }
            .progress-fill {
              height: 100%;
              background-color: #dc2626;
            }
          </style>
        </head>
        <body class="bg-gray-50 p-4">
          ${reportContent}
        </body>
        </html>
      `);
      reportWindow.document.close();
    }
    
    // ---- GENERATE CHANNEL REPORT ROWS ----
    function generateChannelReportRows() {
      const channels = ["Talabat", "Careem Now", "Deliveroo", "Noon Food", "Smiles"];
      let rowsHTML = '';
      
      channels.forEach(channel => {
        const channelOrders = orders.filter(order => order.channel === channel);
        const cancelled = channelOrders.filter(order => order.status === 'Order Cancelled').reduce((sum, order) => sum + order.orderCount, 0);
        const refunded = channelOrders.filter(order => order.status === 'Order Refunded').reduce((sum, order) => sum + order.orderCount, 0);
        const disputed = channelOrders.filter(order => order.status === 'Order Disputed').reduce((sum, order) => sum + order.orderCount, 0);
        const unanswered = channelOrders.filter(order => order.status === 'Unanswered').reduce((sum, order) => sum + order.orderCount, 0);
        const total = channelOrders.reduce((sum, order) => sum + order.orderCount, 0);
        
        // حساب نسبة الإلغاء
        const cancellationRate = total > 0 ? ((cancelled / total) * 100).toFixed(1) : 0;
        
        rowsHTML += `
          <tr>
            <td class="border px-2 py-1 font-medium">${channel}</td>
            <td class="border px-2 py-1">${cancelled}</td>
            <td class="border px-2 py-1">${refunded}</td>
            <td class="border px-2 py-1">${disputed}</td>
            <td class="border px-2 py-1">${unanswered}</td>
            <td class="border px-2 py-1 font-bold">${total}</td>
            <td class="border px-2 py-1">
              <div class="flex items-center">
                <span class="ml-1">${cancellationRate}%</span>
                <div class="progress-bar flex-grow">
                  <div class="progress-fill" style="width: ${cancellationRate}%"></div>
                </div>
              </div>
            </td>
          </tr>
        `;
      });
      
      return rowsHTML;
    }
    
    // ---- GENERATE BRANCH REPORT ROWS ----
    function generateBranchReportRows() {
      const branches = ["Electra", "Mouroor", "Khalydiha", "Satwa", "Hamdan",
